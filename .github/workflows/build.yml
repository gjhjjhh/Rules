name: Build Rules

on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  Build_Rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - uses: actions/checkout@v3
        with:
          ref: build  # æ˜ç¡®æ£€å‡ºbuildåˆ†æ”¯
          fetch-depth: 0

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: æ”¶é›†è§„åˆ™
        run: |
          echo "ç”ŸæˆåŸå§‹åŸŸåæ–‡ä»¶..."
          python collect.py
          echo "domainç›®å½•ç”Ÿæˆå®Œæˆ"

      - name: è½¬æ¢æ ¼å¼
        run: |
          echo "è½¬æ¢æ ¼å¼ç”Ÿæˆoutputç›®å½•..."
          python transform.py
          echo "outputç›®å½•å†…å®¹ï¼š"
          ls -lR output

      - name: ç¼–è¯‘Singbox/Mihomoè§„åˆ™
        run: |
          # ä½¿ç”¨å¹¶è¡Œç¼–è¯‘æé«˜æ•ˆç‡
          compile_singbox() {
            json_file=$1
            dir=$(dirname $json_file)
            (cd $dir && \
              wget -q https://github.com/SagerNet/sing-box/releases/download/v1.11.4/sing-box-1.11.4-linux-amd64.tar.gz -O sing-box.tar.gz && \
              tar -xzf sing-box.tar.gz && \
              ./*/sing-box rule-set compile singbox.json && \
              rm -rf sing-box.tar.gz */)
          }
          export -f compile_singbox
          
          compile_mihomo() {
            yaml_file=$1
            dir=$(dirname $yaml_file)
            (cd $dir && \
              wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.19.3/mihomo-linux-amd64-v1.19.3.gz -O mihomo.gz && \
              gzip -d mihomo.gz && \
              chmod +x mihomo && \
              ./mihomo convert-ruleset domain yaml mihomo.yaml mihomo.mrs && \
              rm -rf mihomo)
          }
          export -f compile_mihomo
          
          # å¹¶è¡Œç¼–è¯‘
          find ./output -name "singbox.json" | xargs -P 4 -I {} bash -c 'compile_singbox "{}"'
          find ./output -name "mihomo.yaml" | xargs -P 4 -I {} bash -c 'compile_mihomo "{}"'

      - name: è®¾ç½®Gité…ç½®
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config core.compression 1

      - name: æäº¤å˜æ›´
        run: |
          # æ‹‰å–æœ€æ–°å˜æ›´é¿å…å†²çª
          git pull origin build --rebase --no-verify
          
          # æ·»åŠ å˜æ›´æ–‡ä»¶
          git add domain output
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼ˆå‚ç…§ç¤ºä¾‹çš„ç®€æ´åˆ¤æ–­æ–¹å¼ï¼‰
          if ! git diff --staged --quiet; then
            git commit -m "ğŸš€ CI Updated - $(date +'%Y-%m-%d %H:%M')" --no-verify
            git push origin build --no-progress --no-verify
          else
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi

      - name: åˆ é™¤è¿œç¨‹buildåˆ†æ”¯
        run: |
          git push origin --delete build || true
        continue-on-error: true

      - name: æ¸…ç†æ—§å·¥ä½œæµ
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 3
