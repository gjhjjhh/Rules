name: Rules Maker

on:
  push:
    branches: [build]
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai
      BRANCH: build

    steps:
      - name: 拉取代码（仅获取build分支）
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH }}
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}  # 显式添加认证令牌

      - name: 配置Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 运行main.py生成domain目录
        run: |
          echo "生成原始域名文件..."
          python main.py
          echo "domain目录生成完成"

      - name: 运行convert_formats.py生成output目录
        run: |
          echo "转换格式生成output目录..."
          python convert_formats.py
          echo "output目录内容："
          ls -lR output  # 替换tree命令

      - name: 编译Singbox/Mihomo规则
        run: |
          set -e  # 启用错误退出机制
          
          # 编译Singbox
          find ./output -name "singbox.json" | while read json_file; do
            dir=$(dirname "$json_file")
            (cd "$dir" && \
              wget -q https://github.com/SagerNet/sing-box/releases/download/v1.11.4/sing-box-1.11.4-linux-amd64.tar.gz -O sing-box.tar.gz && \
              tar -xzf sing-box.tar.gz && \
              ./*/sing-box rule-set compile singbox.json && \
              rm -rf sing-box.tar.gz */)
          done

          # 编译Mihomo
          find ./output -name "mihomo.yaml" | while read yaml_file; do
            dir=$(dirname "$yaml_file")
            (cd "$dir" && \
              wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.19.3/mihomo-linux-amd64-v1.19.3.gz -O mihomo.gz && \
              gzip -d mihomo.gz && \
              chmod +x mihomo && \
              ./mihomo convert-ruleset domain yaml mihomo.yaml mihomo.mrs && \
              rm -rf mihomo)
          done

      - name: 推送output/和domain/的变更
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # 检查实际变更
          git add output/ domain/
          if ! git diff-index --quiet HEAD --; then
            git commit -m "Update: $(date +'%Y-%m-%d %H:%M')"
            git push origin ${{ env.BRANCH }}
          else
            echo "没有检测到变更，跳过提交"
          fi

      - name: 完成
        run: echo "🎉 操作完成"
