name: Build Rules

on:
  schedule:
    - cron: "0 1 * * *"  # ä¿æŒå®šæ—¶è§¦å‘
  workflow_dispatch:  # ä¿æŒæ‰‹åŠ¨è§¦å‘

env:
  TZ: Asia/Shanghai  # ä¿æŒæ—¶åŒºè®¾ç½®
  SINGBOX_VERSION: v1.11.4
  MIHOMO_VERSION: v1.19.3

jobs:
  Build_Rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ä¿ç•™å†™å…¥æƒé™
      actions: write   # ä¿ç•™æ¸…ç†å·¥ä½œæµæƒé™

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œä¼˜åŒ–æäº¤é€Ÿåº¦

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y parallel jq tree

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate domain directory
        run: python main.py

      - name: Generate output directory
        run: python convert_formats.py

      - name: Download and setup tools
        run: |
          # ä¸‹è½½å¹¶è®¾ç½®sing-box
          wget -q https://github.com/SagerNet/sing-box/releases/download/${{ env.SINGBOX_VERSION }}/sing-box-${{ env.SINGBOX_VERSION }}-linux-amd64.tar.gz -O sing-box.tar.gz
          tar -xzf sing-box.tar.gz
          mv sing-box-* sing-box
          chmod +x sing-box/sing-box

          # ä¸‹è½½å¹¶è®¾ç½®mihomo
          wget -q https://github.com/MetaCubeX/mihomo/releases/download/${{ env.MIHOMO_VERSION }}/mihomo-linux-amd64-${{ env.MIHOMO_VERSION }}.gz -O mihomo.gz
          gzip -d mihomo.gz
          chmod +x mihomo

      - name: Compile Singbox rules (parallel)
        run: |
          # ä½¿ç”¨parallelå¹¶è¡Œå¤„ç†
          find ./output -name "singbox.json" -print0 | \
            parallel -0 -j 6 'dir={//}; \
            echo "Compiling $dir/singbox.json"; \
            ./sing-box/sing-box rule-set compile --output "$dir/singbox.srs" "$dir/singbox.json"'

      - name: Compile Mihomo rules (parallel)
        run: |
          # ä½¿ç”¨parallelå¹¶è¡Œå¤„ç†
          find ./output -name "mihomo.yaml" -print0 | \
            parallel -0 -j 6 'dir={//}; \
            echo "Compiling $dir/mihomo.yaml"; \
            ./mihomo convert-ruleset domain yaml "$dir/mihomo.yaml" "$dir/mihomo.mrs"'

      - name: Cleanup tools
        run: |
          rm -rf sing-box* mihomo*

      - name: List output structure
        run: tree output

      - name: Optimized commit and push
        run: |
          # é…ç½®Gitèº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # ä»…æ·»åŠ å˜åŒ–çš„ç›®å½•
          git add output/ domain/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            # åˆ›å»ºä¼˜åŒ–æäº¤
            git commit -m "ğŸš€ CI: Update rules $(date +'%Y-%m-%d %H:%M')" \
              -m "Auto-generated by GitHub Actions"
            
            # ä½¿ç”¨æ¨é€ä¼˜åŒ–
            git pull --rebase
            git push origin main
          else
            echo "No changes detected, skipping commit"
          fi

      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 3
