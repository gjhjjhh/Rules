name: ç”Ÿæˆè§„åˆ™æ–‡ä»¶åˆ°outputç›®å½•

on:
  push:
    branches: [build]
  workflow_dispatch:

jobs:
  generate-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æ·»åŠ å†…å®¹å†™å…¥æƒé™
    env:
      WORKSPACE: ${{ github.workspace }}

    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: æ˜¾ç¤ºç›®å½•ç»“æ„
        run: |
          echo "å½“å‰ä»“åº“æ ¹ç›®å½•æ–‡ä»¶ï¼š"
          ls -la $WORKSPACE

      - name: é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: è¿è¡Œmain.pyç”Ÿæˆdomainç›®å½•
        run: |
          echo "=== ç”ŸæˆåŸå§‹åŸŸåæ–‡ä»¶ ==="
          if [ ! -f "$WORKSPACE/main.py" ]; then
            echo "âŒ é”™è¯¯ï¼š$WORKSPACE/main.pyä¸å­˜åœ¨"
            exit 1
          fi
          python $WORKSPACE/main.py
          if [ ! -d "$WORKSPACE/domain" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆdomainç›®å½•"
            exit 1
          fi
          echo "âœ… domainç›®å½•ç”ŸæˆæˆåŠŸ"

      - name: è¿è¡Œconvert_formats.pyç”Ÿæˆoutputç›®å½•
        run: |
          echo "=== ç”Ÿæˆoutputç›®å½•è§„åˆ™ ==="
          if [ ! -f "$WORKSPACE/convert_formats.py" ]; then
            echo "âŒ é”™è¯¯ï¼š$WORKSPACE/convert_formats.pyä¸å­˜åœ¨"
            exit 1
          fi
          python $WORKSPACE/convert_formats.py
          if [ ! -d "$WORKSPACE/output" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆoutputç›®å½•"
            exit 1
          fi
          echo "âœ… outputç›®å½•ç»“æ„ï¼š"
          tree $WORKSPACE/output

      - name: ç¼–è¯‘Singbox/Mihomoè§„åˆ™é›†
        run: |
          echo "=== ç¼–è¯‘è§„åˆ™é›† ==="
          # ç¼–è¯‘Singbox
          find $WORKSPACE/output -name "singbox.json" | while read json_file; do
            (cd $(dirname $json_file) && \
              wget -q https://github.com/SagerNet/sing-box/releases/download/v1.11.4/sing-box-1.11.4-linux-amd64.tar.gz -O sing-box.tar.gz && \
              tar -xzf sing-box.tar.gz && \
              ./*/sing-box rule-set compile singbox.json && \
              rm -rf sing-box.tar.gz */)
          done
          # ç¼–è¯‘Mihomo
          find $WORKSPACE/output -name "mihomo.yaml" | while read yaml_file; do
            (cd $(dirname $yaml_file) && \
              wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.19.3/mihomo-linux-amd64-v1.19.3.gz -O mihomo.gz && \
              gzip -d mihomo.gz && \
              chmod +x mihomo && \
              ./mihomo convert-ruleset domain yaml mihomo.yaml mihomo.mrs && \
              rm -rf mihomo)
          done

      - name: å®Œæˆæç¤º
        run: |
          echo "ğŸ‰ è§„åˆ™æ–‡ä»¶å·²ç”Ÿæˆåœ¨ï¼š$WORKSPACE/output"
