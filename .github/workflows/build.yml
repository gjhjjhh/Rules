name: Build Rules

on:
  schedule:
    - cron: "0 1 * * *"  # ä¿æŒå®šæ—¶è§¦å‘
  workflow_dispatch:  # ä¿æŒæ‰‹åŠ¨è§¦å‘

env:
  TZ: Asia/Shanghai  # ä¿æŒæ—¶åŒºè®¾ç½®

jobs:
  Build_Rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ä¿ç•™å†™å…¥æƒé™
      actions: write   # ä¿ç•™æ¸…ç†å·¥ä½œæµæƒé™

    steps:
      - uses: actions/checkout@v3  # ä¿æŒåŸcheckoutç‰ˆæœ¬

      # æ›¿æ¢ä¸ºæŒ‡å®šçš„ä¸­é—´è¿‡ç¨‹æ­¥éª¤
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: è¿è¡Œmain.pyç”Ÿæˆdomainç›®å½•
        run: |
          echo "ç”ŸæˆåŸå§‹åŸŸåæ–‡ä»¶..."
          python main.py
          echo "domainç›®å½•ç”Ÿæˆå®Œæˆ"

      - name: è¿è¡Œconvert_formats.pyç”Ÿæˆoutputç›®å½•
        run: |
          echo "è½¬æ¢æ ¼å¼ç”Ÿæˆoutputç›®å½•..."
          python convert_formats.py
          echo "outputç›®å½•ç»“æ„ï¼š"
          tree output

      - name: ç¼–è¯‘Singbox/Mihomoè§„åˆ™
        run: |
          # ç¼–è¯‘Singbox
          find ./output -name "singbox.json" | while read json_file; do
            (cd $(dirname $json_file) && \
              wget -q https://github.com/SagerNet/sing-box/releases/download/v1.11.4/sing-box-1.11.4-linux-amd64.tar.gz -O sing-box.tar.gz && \
              tar -xzf sing-box.tar.gz && \
              ./*/sing-box rule-set compile singbox.json && \
              rm -rf sing-box.tar.gz */)
          done

          # ç¼–è¯‘Mihomo
          find ./output -name "mihomo.yaml" | while read yaml_file; do
            (cd $(dirname $yaml_file) && \
              wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.19.3/mihomo-linux-amd64-v1.19.3.gz -O mihomo.gz && \
              gzip -d mihomo.gz && \
              chmod +x mihomo && \
              ./mihomo convert-ruleset domain yaml mihomo.yaml mihomo.mrs && \
              rm -rf mihomo)
          done

      # ä¿ç•™åŸè‡ªåŠ¨æäº¤æ¨é€æ­¥éª¤
      - name: Commit & Push Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: ğŸš€ CI Updated

      # ä¿ç•™åŸæ¸…ç†æ—§å·¥ä½œæµæ­¥éª¤
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 3
