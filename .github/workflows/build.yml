name: Rules Maker

on:
  push:
    branches: [build]
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai
      BRANCH: build

    steps:
      - name: æ‹‰å–ä»£ç ï¼ˆä»…è·å–buildåˆ†æ”¯ï¼‰
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH }}  # ç›´æ¥åˆ‡åˆ°buildåˆ†æ”¯
          fetch-depth: 1  # åªæ‹‰å–æœ€æ–°æäº¤ï¼Œç®€å•åŸºç¡€

      - name: é…ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: è¿è¡Œmain.pyç”Ÿæˆdomainç›®å½•
        run: |
          echo "ç”ŸæˆåŸå§‹åŸŸåæ–‡ä»¶..."
          python main.py
          echo "domainç›®å½•ç”Ÿæˆå®Œæˆ"

      - name: è¿è¡Œconvert_formats.pyç”Ÿæˆoutputç›®å½•
        run: |
          echo "è½¬æ¢æ ¼å¼ç”Ÿæˆoutputç›®å½•..."
          python convert_formats.py
          echo "outputç›®å½•ç»“æ„ï¼š"
          tree output

      - name: ç¼–è¯‘Singbox/Mihomoè§„åˆ™
        run: |
          # ç¼–è¯‘Singbox
          find ./output -name "singbox.json" | while read json_file; do
            (cd $(dirname $json_file) && \
              wget -q https://github.com/SagerNet/sing-box/releases/download/v1.11.4/sing-box-1.11.4-linux-amd64.tar.gz -O sing-box.tar.gz && \
              tar -xzf sing-box.tar.gz && \
              ./*/sing-box rule-set compile singbox.json && \
              rm -rf sing-box.tar.gz */)
          done

          # ç¼–è¯‘Mihomo
          find ./output -name "mihomo.yaml" | while read yaml_file; do
            (cd $(dirname $yaml_file) && \
              wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.19.3/mihomo-linux-amd64-v1.19.3.gz -O mihomo.gz && \
              gzip -d mihomo.gz && \
              chmod +x mihomo && \
              ./mihomo convert-ruleset domain yaml mihomo.yaml mihomo.mrs && \
              rm -rf mihomo)
          done

      - name: æ¨é€output/å’Œdomain/çš„å˜æ›´
        run: |
          # åŸºç¡€é…ç½®èº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ éœ€è¦æ¨é€çš„ç›®å½•
          git add output/ domain/

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            # æäº¤
            git commit -m "Update: $(date +'%Y-%m-%d %H:%M')"
            # ç®€å•ç›´æ¥æ¨é€å½“å‰åˆ†æ”¯åˆ°è¿œç¨‹buildåˆ†æ”¯
            git push origin ${{ env.BRANCH }}
          fi

      - name: å®Œæˆ
        run: echo "ğŸ‰ æ“ä½œå®Œæˆ"
